---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from '../components/SEO.astro';
import HeroSection from '../components/HeroSection';
import FeatureGrid from '../components/FeatureGrid';
import PricingSection from '../components/PricingSection';
import FAQSection from '../components/FAQSection';
import TestimonialSection from '../components/TestimonialSection';
import CTASection from '../components/CTASection';
import {
  generateOrganizationSchema,
  generateProductSchema,
  generateWebSiteSchema,
  generateBreadcrumbSchema,
} from '../utils/schema';

const [serviceInfoEntries, pricingPlans, faqItems, testimonials] = await Promise.all([
  getCollection('service-info'),
  getCollection('pricing'),
  getCollection('faq'),
  getCollection('testimonials').catch(() => []),
]);

const serviceInfo = serviceInfoEntries[0];
const data = serviceInfo?.data || {};

const baseUrl = data.siteUrl || Astro.url.origin;

const organizationSchema = generateOrganizationSchema({
  name: data.brandName,
  url: baseUrl,
  logo: `${baseUrl}/favicon.svg`,
  description: data.description,
  email: data.supportEmail,
  phone: data.supportPhone,
  socialProfiles: Object.values(data.socialLinks || {}).filter(Boolean) as string[],
});

const productSchema = generateProductSchema({
  name: `${data.brandName} IPTV Subscription`,
  description: data.description,
  brand: data.brandName,
  offers: pricingPlans.map(plan => ({
    priceCurrency: plan.data.currency,
    price: plan.data.price,
    name: plan.data.name,
    url: `${baseUrl}/pricing`,
  })),
  aggregateRating: {
    ratingValue: 4.8,
    reviewCount: testimonials.length || 150,
  },
});

const websiteSchema = generateWebSiteSchema(
  data.brandName,
  baseUrl,
  data.description
);

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: baseUrl },
]);

const schemas = [organizationSchema, productSchema, websiteSchema, breadcrumbSchema];

const sortedPricing = [...pricingPlans].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const sortedFaq = [...faqItems].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
---

<BaseLayout>
  <SEO
    slot="head"
    title={data.brandName}
    description={data.description}
    canonicalURL={baseUrl}
    ogImage={`${baseUrl}/og-image.jpg`}
    schema={schemas}
  />

  <HeroSection
    client:load
    title={data.brandName}
    subtitle={data.tagline}
    channelCount={data.channelCount}
    vodCount={data.vodCount}
    primaryColor={data.primaryColor}
  />

  {data.features && data.features.length > 0 && (
    <FeatureGrid client:visible features={data.features} primaryColor={data.primaryColor} />
  )}

  {sortedPricing.length > 0 && (
    <PricingSection
      client:visible
      plans={sortedPricing.map(p => ({ ...p.data, slug: p.id }))}
      primaryColor={data.primaryColor}
    />
  )}

  {sortedFaq.length > 0 && (
    <FAQSection client:visible items={sortedFaq.map(f => ({ question: f.data.question, answer: f.body || '' }))} />
  )}

  {testimonials.length > 0 && (
    <TestimonialSection
      client:visible
      testimonials={testimonials.map(t => ({ ...t.data, content: t.body || '' }))}
    />
  )}

  <CTASection
    client:visible
    title="Ready to Start Streaming?"
    subtitle="Join thousands of satisfied customers and experience premium entertainment"
    buttonText="Get Started Now"
    buttonLink="/pricing"
    primaryColor={data.primaryColor}
  />
</BaseLayout>
